<UserControl x:Class="desktop_app.Views.UpdateRoomWindow"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d"
             d:DesignHeight="650" d:DesignWidth="1200">

    <Grid Margin="18">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- HEADER -->
        <Border Grid.Row="0"
                Style="{StaticResource BgColor}"
                CornerRadius="16"
                Padding="14"
                Margin="0,0,0,12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel>
                    <TextBlock Text="Crear habitación"
                               FontSize="22"
                               FontWeight="Bold"
                               Foreground="White"/>
                    <TextBlock Text="Rellena los datos y guarda."
                               Foreground="#EAF3FA"
                               Margin="0,4,0,0"/>
                </StackPanel>

            </Grid>
        </Border>

        <!-- CARD -->
        <Border Grid.Row="1"
                Background="White"
                BorderBrush="{StaticResource SoftBorder}"
                BorderThickness="1"
                CornerRadius="16"
                Padding="14">
            <ScrollViewer VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled"
                  CanContentScroll="True">

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- 0 -->
                        <RowDefinition Height="Auto"/>
                        <!-- 1 -->
                        <RowDefinition Height="Auto"/>
                        <!-- 2 -->
                        <RowDefinition Height="Auto"/>
                        <!-- 3 -->
                        <RowDefinition Height="Auto"/>
                        <!-- 4 -->
                        <RowDefinition Height="Auto"/>
                        <!-- footer -->
                    </Grid.RowDefinitions>

                    <!-- ===== FILA 0 ===== -->
                    <StackPanel Grid.Column="0" Grid.Row="0" Margin="0,0,12,10">
                        <TextBlock Text="Número" Style="{StaticResource CompactLabel}"/>
                        <TextBox Style="{StaticResource CompactTextBox}"
                             Text="{Binding Room.RoomNumber, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Grid.Row="0" Margin="0,0,12,10">
                        <TextBlock Text="Tipo" Style="{StaticResource CompactLabel}"/>
                        <ComboBox Height="30"
                              Padding="10,0"
                              Background="#F3F5F8"
                              BorderBrush="{StaticResource SoftBorder}"
                              BorderThickness="1"
                              SelectedValue="{Binding Room.Type, UpdateSourceTrigger=PropertyChanged}"
                              SelectedValuePath="Tag">
                            <ComboBoxItem Content="single" Tag="single"/>
                            <ComboBoxItem Content="double" Tag="double"/>
                            <ComboBoxItem Content="suite"  Tag="suite"/>
                            <ComboBoxItem Content="family" Tag="family"/>
                        </ComboBox>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Grid.Row="0" Margin="0,0,0,10">
                        <TextBlock Text="Precio/noche (€)" Style="{StaticResource CompactLabel}"/>
                        <TextBox Style="{StaticResource CompactTextBox}"
                             Text="{Binding Room.PricePerNight, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <!-- ===== FILA 1 ===== -->
                    <StackPanel Grid.Column="0" Grid.Row="1" Margin="0,0,12,10">
                        <TextBlock Text="Máx. huéspedes" Style="{StaticResource CompactLabel}"/>
                        <TextBox Style="{StaticResource CompactTextBox}"
                             Text="{Binding Room.MaxGuests, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Grid.Row="1" Margin="0,0,12,10">
                        <TextBlock Text="Extras (csv)" Style="{StaticResource CompactLabel}"/>
                        <TextBox Style="{StaticResource CompactTextBox}"
                             Text="{Binding ExtrasText, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Grid.Row="1" Margin="0,0,0,10">
                        <TextBlock Text="Oferta" Style="{StaticResource CompactLabel}"/>
                        <TextBox Style="{StaticResource CompactTextBox}"
                             Text="{Binding Room.Offer, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <!-- ===== FILA 2 ===== -->
                    <StackPanel Grid.Column="0" Grid.Row="2" Margin="0,0,12,10">
                        <TextBlock Text="Rate" Style="{StaticResource CompactLabel}"/>
                        <TextBox Style="{StaticResource CompactTextBox}"
                             Text="{Binding Room.Rate, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Grid.Row="2" Grid.ColumnSpan="3" Margin="0,2,0,10">
                        <TextBlock Text="Opciones" Style="{StaticResource CompactLabel}"/>
                        <WrapPanel>
                            <CheckBox Content="Disponible"
                                  Style="{StaticResource CompactCheckBox}"
                                  IsChecked="{Binding Room.IsAvailable}"/>
                            <CheckBox Content="Cama extra"
                                  Style="{StaticResource CompactCheckBox}"
                                  IsChecked="{Binding Room.ExtraBed}"/>
                            <CheckBox Content="Cuna"
                                  Style="{StaticResource CompactCheckBox}"
                                  IsChecked="{Binding Room.Crib}"/>
                        </WrapPanel>
                    </StackPanel>

                    <!-- FOTOS ocupa col 1 y 2 -->
                    <StackPanel Grid.Column="0" Grid.Row="3" Grid.ColumnSpan="3" Margin="150,0,150,10">
                        <TextBlock Text="Fotos" Style="{StaticResource CompactLabel}"/>

                        <Grid Margin="0,6,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="12"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>

                            <!-- FOTO PRINCIPAL -->
                            <Border Grid.Column="0" Style="{StaticResource MiniDropCard}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Width="34" Height="34" CornerRadius="12" Background="#E6F0FF" Margin="0,0,10,0">
                                        <TextBlock Text="📷" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Border>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="Principal" FontWeight="SemiBold" Foreground="#223045"/>
                                        <TextBlock Text="{Binding MainImageLabel}"
                                               Foreground="#6B778C"
                                               FontSize="12"
                                               TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>

                                    <Button Grid.Column="2"
                                        Style="{StaticResource MiniActionBtn}"
                                        Content="Elegir"
                                        Command="{Binding PickMainImageLocalCommand}"/>
                                </Grid>
                            </Border>

                            <!-- FOTOS EXTRA -->
                            <Border Grid.Column="2" Style="{StaticResource MiniDropCard}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <Border Width="34" Height="34" CornerRadius="12" Background="#FFF3E6" Margin="0,0,10,0">
                                        <TextBlock Text="🖼️" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                                    </Border>

                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="Extras" FontWeight="SemiBold" Foreground="#223045"/>

                                        <StackPanel Orientation="Horizontal" Margin="0,2,0,0" VerticalAlignment="Center">
                                            <Border Style="{StaticResource MiniBadge}">
                                                <TextBlock Text="{Binding ExtraImagesLabel}" Foreground="#2B4B7A" FontSize="12"/>
                                            </Border>
                                            <TextBlock Text=" · se suben al Guardar"
                                                   Foreground="#6B778C"
                                                   FontSize="12"
                                                   Margin="8,0,0,0"/>
                                        </StackPanel>
                                    </StackPanel>

                                    <Button Grid.Column="2"
                                        Style="{StaticResource MiniActionBtn}"
                                        Content="Elegir"
                                        Command="{Binding PickExtraImagesLocalCommand}"/>
                                </Grid>
                            </Border>
                        </Grid>

                        <!-- ===== GALERÍA: IMÁGENES EXISTENTES (elige cuáles borrar) =====
                         Requiere que el VM exponga:
                         - ExistingImages : IEnumerable con items que tengan:
                           * AbsoluteUrl (string)  -> URL completa para BitmapImage
                           * Url (string)          -> "/uploads/xxx.jpg" (para borrar)
                           * IsMain (bool)         -> opcional (para badge "Principal")
                           * OriginalName (string) -> opcional
                    -->
                        <Border Margin="0,12,0,0"
                            BorderBrush="{StaticResource SoftBorder}"
                            BorderThickness="1"
                            CornerRadius="14"
                            Background="#FAFBFD"
                            Padding="10">
                            <StackPanel>
                                <TextBlock Text="Fotos actuales (puedes eliminarlas)"
                                       FontSize="12"
                                       FontWeight="SemiBold"
                                       Foreground="#111827"
                                       Margin="2,0,0,8"/>

                                <ItemsControl ItemsSource="{Binding ExistingImages}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <WrapPanel />
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>

                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Width="140"
                                                Height="105"
                                                CornerRadius="12"
                                                BorderBrush="{StaticResource SoftBorder}"
                                                BorderThickness="1"
                                                Background="#EEF3F7"
                                                Margin="0,0,10,10"
                                                ClipToBounds="True">
                                                <Grid>
                                                    <!-- Miniatura -->
                                                    <Image Stretch="UniformToFill"
                                                   Source="{Binding AbsoluteUrl}"
                                                   />


                                                    <!-- Texto si no hay imagen -->
                                                    <TextBlock Text="Sin imagen"
                                                           Foreground="{StaticResource MutedText}"
                                                           HorizontalAlignment="Center"
                                                           VerticalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding AbsoluteUrl}" Value="{x:Null}">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding AbsoluteUrl}" Value="">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>

                                                    <!-- Badge "Principal" (opcional si el VM expone IsMain) -->
                                                    <Border Background="#AA000000"
                                                        CornerRadius="999"
                                                        Padding="8,3"
                                                        HorizontalAlignment="Left"
                                                        VerticalAlignment="Top"
                                                        Margin="8">
                                                        <Border.Style>
                                                            <Style TargetType="Border">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsMain}" Value="True">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Border.Style>
                                                        <TextBlock Text="Principal" Foreground="White" FontSize="11" FontWeight="SemiBold"/>
                                                    </Border>

                                                    <!-- Botón borrar -->
                                                    <Button Content="🗑"
                                                        Width="34" Height="30"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Top"
                                                        Margin="8"
                                                        Style="{StaticResource DangerIconButton}"
                                                        Command="{Binding DataContext.DeleteImageCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                        CommandParameter="{Binding}" />
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <TextBlock Text="* Al borrar, se elimina del servidor y se quita del modelo de la habitación."
                                       Foreground="{StaticResource MutedText}"
                                       FontSize="11"
                                       Margin="2,2,0,0"/>
                            </StackPanel>
                        </Border>

                    </StackPanel>

                    <!-- ===== FILA 4 ===== -->
                    <StackPanel Grid.Column="0" Grid.Row="4" Grid.ColumnSpan="3" Margin="0,0,0,6">
                        <TextBlock Text="Descripción" Style="{StaticResource CompactLabel}"/>
                        <TextBox Height="60"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             Padding="10,8"
                             Background="#F3F5F8"
                             BorderBrush="{StaticResource SoftBorder}"
                             BorderThickness="1"
                             Text="{Binding Room.Description, UpdateSourceTrigger=PropertyChanged}"/>
                    </StackPanel>


                    <Grid Grid.Row="5" Grid.Column="0" Grid.ColumnSpan="3" Margin="0,10,0,0" HorizontalAlignment="Right">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <Button Grid.Column="0"
                            Style="{StaticResource GhostButton}"
                            Content="Cancelar"
                            Height="32"
                            Width="90"
                            Padding="14,0"
                            Command="{Binding CancelCommand}"/>

                        <Button Grid.Column="2"
                            Style="{StaticResource PrimaryButton}"
                            Content="Guardar"
                            Height="32"
                            Width="90"
                            Padding="16,0"
                            Command="{Binding SaveCommand}"/>
                    </Grid>
                </Grid>
            </ScrollViewer>
        </Border>
    </Grid>
</UserControl>